@model LibraryManagmentSystemIdentity.Models.BooksModel

@{
    ViewData["Title"] = "Edit Book";
}

<h2 class="text-center">✍ Edit Book</h2>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="BookId" />

    <div class="mb-3">
        <label asp-for="BookName" class="form-label">📖 Book Name</label>
        <input asp-for="BookName" class="form-control" required />
        <span asp-validation-for="BookName" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Description" class="form-label">📝 Description</label>
        <textarea asp-for="Description" class="form-control" rows="3"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="AuthorId" class="form-label">✍ Select Author</label>
        <select asp-for="AuthorId" class="form-control" id="authorDropdown">
            <option value="">-- Search & Select Author --</option>
            @if (ViewBag.Authors != null)
            {
                foreach (var author in ViewBag.Authors)
                {
                    <option value="@author.AuthorId">@author.AuthorName</option>
                }
            }
        </select>
        <span asp-validation-for="AuthorId" class="text-danger"></span>
    </div>

    <div class="text-center">
        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
        <a asp-action="Index" class="btn btn-secondary"><i class="fas fa-times"></i> Cancel</a>
    </div>
</form>

<!-- Include jQuery & Select2 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<script>
    $(document).ready(function () {
        $("#authorDropdown").select2({
            placeholder: "Search and select an author",
            allowClear: true,
            width: '100%',
            ajax: {
                url: '@Url.Action("SearchAuthors", "Book")',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { searchTerm: params.term };
                },
                processResults: function (data) {
                    return {
                        results: $.map(data, function (item) {
                            return {
                                id: item.authorId,
                                text: item.authorName
                            };
                        })
                    };
                },
                cache: true
            }
        });

        // Preselect the current author if editing an existing book
        var selectedAuthorId = '@Model.AuthorId';
        if (selectedAuthorId) {
            $.ajax({
                url: '@Url.Action("GetAuthorById", "Book")',
                data: { id: selectedAuthorId },
                dataType: 'json',
                success: function (data) {
                    var option = new Option(data.authorName, data.authorId, true, true);
                    $("#authorDropdown").append(option).trigger('change');
                }
            });
        }
    });
</script>
